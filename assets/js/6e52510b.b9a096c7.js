"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[7377],{7744:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var o=t(4848),s=t(8453);const i={title:"2024-10-17 Docker On Macs",slug:"2024/docker-on-macs",tags:["2024-10","2024","docker","macbook","lima","multiarch"]},r=void 0,a={permalink:"/blog/2024/docker-on-macs",source:"@site/../blogs/2024-10-17-docker-on-macs.md",title:"2024-10-17 Docker On Macs",description:"Docker has been pushing more and more for Docker Desktop, and most of their documentation is now centered around Docker Desktop. Good for them. We all need bread on the table. They are also very committed to keeping the Docker Engine and CLI open source. Good for us. I think it's a win-win. This post is about setting up Docker on Macs without Docker Desktop. It should integrate as if you are running Docker natively on your Mac and support multi-arch images (still lots of AMD servers out there).",date:"2024-10-17T00:00:00.000Z",tags:[{inline:!0,label:"2024-10",permalink:"/blog/tags/2024-10"},{inline:!0,label:"2024",permalink:"/blog/tags/2024"},{inline:!0,label:"docker",permalink:"/blog/tags/docker"},{inline:!0,label:"macbook",permalink:"/blog/tags/macbook"},{inline:!0,label:"lima",permalink:"/blog/tags/lima"},{inline:!0,label:"multiarch",permalink:"/blog/tags/multiarch"}],readingTime:5.89,hasTruncateMarker:!0,authors:[],frontMatter:{title:"2024-10-17 Docker On Macs",slug:"2024/docker-on-macs",tags:["2024-10","2024","docker","macbook","lima","multiarch"]},unlisted:!1,prevItem:{title:"Resume Umesh Poswal",permalink:"/blog/resume-umesh-poswal"},nextItem:{title:"2024-10-09 The Internet Today",permalink:"/blog/2024/the-internet-today"}},l={authorsImageUrls:[]},c=[{value:"Instllation",id:"instllation",level:2},{value:"Create a Lima instance",id:"create-a-lima-instance",level:2},{value:"Next steps",id:"next-steps",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"Docker has been pushing more and more for Docker Desktop, and most of their documentation is now centered around Docker Desktop. Good for them. We all need bread on the table. They are also very committed to keeping the Docker Engine and CLI open source. Good for us. I think it's a win-win. This post is about setting up Docker on Macs without Docker Desktop. It should integrate as if you are running Docker natively on your Mac and support multi-arch images (still lots of AMD servers out there)."}),"\n",(0,o.jsxs)(n.p,{children:["Okay, so let's keep it simple without further blabbering. We are going to use ",(0,o.jsx)(n.a,{href:"https://github.com/lima-vm/lima",children:"Lima"})," to create a Linux VM with Docker and install Docker CLI on the MacBook. The CLI will connect to the Docker daemon running on the Linux VM transparently."]}),"\n",(0,o.jsx)(n.h2,{id:"instllation",children:"Instllation"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"brew install lima\nbrew install --formula docker # docker cli\nbrew install docker-buildx # follow post installation instructions\n"})}),"\n",(0,o.jsx)(n.h2,{id:"create-a-lima-instance",children:"Create a Lima instance"}),"\n",(0,o.jsx)(n.p,{children:"Use following for the VM template."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'# ===================================================================== #\n# BASIC CONFIGURATION\n# ===================================================================== #\nimages:\n  # Try to use release-yyyyMMdd image if available. Note that release-yyyyMMdd will be removed after several months.\n  - location: "https://cloud-images.ubuntu.com/releases/24.04/release-20240821/ubuntu-24.04-server-cloudimg-amd64.img"\n    arch: "x86_64"\n    digest: "sha256:0e25ca6ee9f08ec5d4f9910054b66ae7163c6152e81a3e67689d89bd6e4dfa69"\n  - location: "https://cloud-images.ubuntu.com/releases/24.04/release-20240821/ubuntu-24.04-server-cloudimg-arm64.img"\n    arch: "aarch64"\n    digest: "sha256:5ecac6447be66a164626744a87a27fd4e6c6606dc683e0a233870af63df4276a"\n  # Fallback to the latest release image.\n  # Hint: run `limactl prune` to invalidate the cache\n  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"\n    arch: "x86_64"\n  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"\n    arch: "aarch64"\n# CPUs\n# \ud83d\udfe2 Builtin default: min(4, host CPU cores)\ncpus: 4\n# Memory size\n# \ud83d\udfe2 Builtin default: min("4GiB", half of host memory)\nmemory: "12GiB"\n# Disk size\n# \ud83d\udfe2 Builtin default: "100GiB"\ndisk: "120GiB"\nmounts:\n  - location: "~/"\n    writable: true\n# containerd is managed by Docker, not by Lima, so the values are set to false here.\ncontainerd:\n  system: false\n  user: false\nprovision:\n  - mode: system\n    # This script defines the host.docker.internal hostname when hostResolver is disabled.\n    # It is also needed for lima 0.8.2 and earlier, which does not support hostResolver.hosts.\n    # Names defined in /etc/hosts inside the VM are not resolved inside containers when\n    # using the hostResolver; use hostResolver.hosts instead (requires lima 0.8.3 or later).\n    script: |\n      #!/bin/sh\n      sed -i \'s/host.lima.internal.*/host.lima.internal host.docker.internal/\' /etc/hosts\n  - mode: system\n    script: |\n      #!/bin/bash\n      set -eux -o pipefail\n      command -v docker >/dev/null 2>&1 && exit 0\n      export DEBIAN_FRONTEND=noninteractive\n      curl -fsSL https://get.docker.com | sh\n      # NOTE: you may remove the lines below, if you prefer to use rootful docker, not rootless\n      systemctl disable --now docker\n      apt-get install -y uidmap dbus-user-session\n  - mode: user\n    script: |\n      #!/bin/bash\n      set -eux -o pipefail\n      systemctl --user start dbus\n      dockerd-rootless-setuptool.sh install\n      docker context use rootless\n  # Enable cpu emulation - https://docs.docker.com/build/building/multi-platform/#qemu\n  - mode: system\n    script: |\n      #!/bin/bash\n      set -eux -o pipefail\n      docker run --privileged --rm tonistiigi/binfmt --install all\nprobes:\n  - script: |\n      #!/bin/bash\n      set -eux -o pipefail\n      if ! timeout 30s bash -c "until command -v docker >/dev/null 2>&1; do sleep 3; done"; then\n        echo >&2 "docker is not installed yet"\n        exit 1\n      fi\n      if ! timeout 30s bash -c "until pgrep rootlesskit; do sleep 3; done"; then\n        echo >&2 "rootlesskit (used by rootless docker) is not running"\n        exit 1\n      fi\n    hint: See "/var/log/cloud-init-output.log". in the guest\nhostResolver:\n  # hostResolver.hosts requires lima 0.8.3 or later. Names defined here will also\n  # resolve inside containers, and not just inside the VM itself.\n  hosts:\n    host.docker.internal: host.lima.internal\ntimezone: Asia/Tokyo\nportForwards:\n  - guestSocket: "/run/user/{{.UID}}/docker.sock"\n    hostSocket: "{{.Dir}}/sock/docker.sock"\nmessage: |\n  To run `docker` on the host (assumes docker-cli is installed), run the following commands:\n  ------\n  sudo /bin/ln -s -f {{.Dir}}/sock/docker.sock /var/run/docker.sock\n  docker run hello-world\n  ------\n  It creates a symlink to the docker socket in the host\'s filesystem allowing seamless integration with docker commands.\n  Optionally, run following command to enable building multi-arch images:\n  ------\n  docker buildx create --name container-builder --driver docker-container --bootstrap --use\n  # then you can build multi-arch images like this:\n  docker buildx build --platform linux/amd64,linux/arm64 -t <your-image-name> .\n  ------\nnetworks:\n  # Lima can manage daemons for networks defined in $LIMA_HOME/_config/networks.yaml\n  # automatically. The socket_vmnet binary must be installed into\n  # secure locations only alterable by the "root" user.\n  - lima: bridged\n    # MAC address of the instance; lima will pick one based on the instance name,\n    # so DHCP assigned ip addresses should remain constant over instance restarts.\n    macAddress: ""\n'})}),"\n",(0,o.jsx)(n.p,{children:"A couple of noteworthy things about our template:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"We have a provision script to install Docker in rootless mode. This script comes from the default template provided by Lima for Docker."}),"\n",(0,o.jsx)(n.li,{children:"Port forwarding is set to mount the Docker socket inside the VM to the host."}),"\n",(0,o.jsx)(n.li,{children:"Steps shown in the message create a soft link. It links the default Docker socket file expected by the Docker clients to the socket file we mounted in the last step. This will help our clients transparently talk to the Docker daemon as if it were running natively on the host without further modifications."}),"\n",(0,o.jsxs)(n.li,{children:["I'm also using ",(0,o.jsx)(n.code,{children:"bridged"})," networking. ",(0,o.jsx)(n.code,{children:"socket_vmnet"})," should be installed for it to work. Check Lima docs for more info."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Alrighty, let's create the VM using above template. I'm naming the VM ",(0,o.jsx)(n.code,{children:"docker"}),". Assuming you create the template file at ",(0,o.jsx)(n.code,{children:"/tmp/lima-docker.yaml"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"limactl create --name docker /tmp/lima-docker.yaml\nlimactl start docker\n"})}),"\n",(0,o.jsx)(n.p,{children:"Follow the instructions printed by the start command to create a soft link for the Docker socket file and set up Docker buildx for multi-arch image building."}),"\n",(0,o.jsx)(n.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["After running ",(0,o.jsx)(n.code,{children:"limactl create"}),", Lima should have created a ",(0,o.jsx)(n.code,{children:"~/.lima/docker/lima.yaml"})," file. If you need to make any changes to your machine/template, update that file and restart the Lima machine."]}),"\n",(0,o.jsx)(n.li,{children:"You should be all set for using Docker. Start using Docker as if it\u2019s running natively."}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'docker run --rm hello-world\n\nHello from Docker!\nThis message shows that your installation appears to be working correctly.\n\nTo generate this message, Docker took the following steps:\n 1. The Docker client contacted the Docker daemon.\n 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.\n    (arm64v8)\n 3. The Docker daemon created a new container from that image which runs the\n    executable that produces the output you are currently reading.\n 4. The Docker daemon streamed that output to the Docker client, which sent it\n    to your terminal.\n'})}),"\n",(0,o.jsxs)(n.ol,{start:"3",children:["\n",(0,o.jsxs)(n.li,{children:["(Optional) This setup can build and run images targeted for different platform. For example, M series Macbooks are ARM based (previous command outputted ",(0,o.jsx)(n.code,{children:"(arm64v8)"}),"). But you can run and build AMD images as well."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'docker run --rm --platform linux/amd64 hello-world\n\nHello from Docker!\nThis message shows that your installation appears to be working correctly.\n\nTo generate this message, Docker took the following steps:\n 1. The Docker client contacted the Docker daemon.\n 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.\n    (amd64)\n 3. The Docker daemon created a new container from that image which runs the\n    executable that produces the output you are currently reading.\n 4. The Docker daemon streamed that output to the Docker client, which sent it\n    to your terminal.\n'})}),"\n",(0,o.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://docs.docker.com/build/building/multi-platform/",children:"https://docs.docker.com/build/building/multi-platform/"})}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://gist.github.com/fuzmish/df9eabf711c3f452ca19cce0621fc84e",children:"https://gist.github.com/fuzmish/df9eabf711c3f452ca19cce0621fc84e"})," - gave the idea of using a symlink for the docker socket file"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://lima-vm.io/docs/config/network/#vmnet-networks",children:"https://lima-vm.io/docs/config/network/#vmnet-networks"})," - for bridged networking"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var o=t(6540);const s={},i=o.createContext(s);function r(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);